<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{_layout :: layout('Editar Pedido', 'pedidos', ~{::content})}">

<section class="section" th:fragment="content">

  <h2 class="section-title">Editar Pedido (Etapa 2 de 2)</h2>

  <div class="mt-16">
    <strong>Pedido ID:</strong> <span th:text="${pedido.id}">#00</span><br/>
    <strong>Cliente:</strong> 
    <span th:text="${pedido.nomeClienteObservacao}">Nome do Cliente</span><br/>
    <strong>Status:</strong> <span th:text="${pedido.status}">ABERTO</span>
  </div>

  <hr style="border-color: var(--stroke); margin: 20px 0;"/>

  <h3 class="section-subtitle">Itens do Pedido</h3>

  <div class="table-wrap">
    <table class="table">
      <thead>
        <tr>
          <th>Produto</th>
          <th>Qtd.</th>
          <th>Preço Unit.</th>
          <th>Subtotal</th>
          <th>Ação</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="item : ${pedido.itens}">
          <th:block th:if="${editItemId != null AND item.id == editItemId}">
            <td style="vertical-align: middle;" th:text="${item.produto.nome}">Produto</td>
            <td style="vertical-align: middle;">
              <form th:action="@{/pedidos/editar/atualizar-item}" method="POST" style="display: flex; align-items: center; gap: 6px;">
                <input type="hidden" name="pedidoId" th:value="${pedido.id}" />
                <input type="hidden" name="itemPedidoId" th:value="${item.id}" />
                <input type="number" name="quantidade" th:value="${item.quantidade}" min="1" class="form-control" style="width: 70px; height: 34px; padding: 5px 8px;" />
                <button type="submit" class="btn btn-sm">OK</button>
              </form>
            </td>
            <td style="vertical-align: middle;" th:text="${'R$ ' + #numbers.formatDecimal(item.precoUnitario,1,'POINT',2,'COMMA')}">R$ 0,00</td>
            <td style="vertical-align: middle;" th:text="${'R$ ' + #numbers.formatDecimal(item.getSubtotal(),1,'POINT',2,'COMMA')}">R$ 0,00</td>
            <td style="vertical-align: middle;">
              <a th:href="@{/pedidos/editar/{id}(id=${pedido.id})}" class="btn btn-sm btn-ghost">Cancelar</a>
            </td>
          </th:block>
          <th:block th:unless="${editItemId != null AND item.id == editItemId}">
            <td style="vertical-align: middle;" th:text="${item.produto.nome}">Produto</td>
            <td style="vertical-align: middle;" th:text="${item.quantidade}">1</td>
            <td style="vertical-align: middle;" th:text="${'R$ ' + #numbers.formatDecimal(item.precoUnitario,1,'POINT',2,'COMMA')}">R$ 0,00</td>
            <td style="vertical-align: middle;" th:text="${'R$ ' + #numbers.formatDecimal(item.getSubtotal(),1,'POINT',2,'COMMA')}">R$ 0,00</td>
            <td style="vertical-align: middle; white-space: nowrap;">
              <a th:href="@{/pedidos/editar/{id}(id=${pedido.id}, editItemId=${item.id})}" class="btn btn-sm">
                Editar
              </a>
              <form th:action="@{/pedidos/editar/remover-item}" method="POST" style="display: inline-block; margin-left: 6px;">
                <input type="hidden" name="pedidoId" th:value="${pedido.id}" />
                <input type="hidden" name="itemPedidoId" th:value="${item.id}" />
                <button type="submit" class="btn btn-sm btn-ghost">Remover</button>
              </form>
            </td>
          </th:block>
        </tr>
        <tr th:if="${#lists.isEmpty(pedido.itens)}">
          <td colspan="5" style="text-align: center; color: var(--muted);">
            Nenhum item adicionado a este pedido.
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr style="font-size: 1.2em; font-weight: 700;">
          <td colspan="3" style="text-align: right;">TOTAL:</td>
          <td colspan="2" th:text="${'R$ ' + #numbers.formatDecimal(pedido.total,1,'POINT',2,'COMMA')}">R$ 0,00</td>
        </tr>
      </tfoot>
    </table>
  </div>

  <hr style="border-color: var(--stroke); margin: 20px 0;"/>

  <h3 class="section-subtitle">Adicionar Novo Item</h3>

  <form th:action="@{/pedidos/editar/adicionar-item}" method="POST" class="form-row">
    <input type="hidden" name="pedidoId" th:value="${pedido.id}" />
    <div class="form-group" style="flex: 3;">
      <label for="produtoId">Produto</label>
      
      <select id="produtoId" name="produtoId" placeholder="Digite ou selecione um produto...">
        <option value="" selected>Digite ou selecione um produto...</option>
        
        <option th:each="prod : ${produtos}"
                th:if="${prod.ativo}"
                th:value="${prod.id}"
                th:text="${prod.nome + ' (R$ ' + #numbers.formatDecimal(prod.preco,1,'POINT',2,'COMMA') + ')'}">
          Produto (Preço)
        </option>
      </select>
    </div>
    <div class="form-group" style="flex: 1;">
      <label for="quantidade">Quantidade</label>
      <input type="number" id="quantidade" name="quantidade" value="1" min="1" class="form-control" />
    </div>
    <div class="form-group" style="align-self: flex-end;">
      <button type="submit" class="btn">Adicionar</S>
    </div>
  </form>

  <div class="form-actions mt-22">
    <a th:href="@{/}" class="btn">Concluir Edição (Voltar)</a>
  </div>

  <style>
    .ts-control {
      background: #FFFFFF !important;
      color: #1F2937 !important;
      border: 1px solid #E5E7EB !important;
      border-radius: 8px !important;
      padding: 10px 12px !important;
      height: 48px; 
    }
    .ts-control.focus {
      border-color: #E53E3E !important; 
      box-shadow: 0 0 0 3px rgba(229, 62, 62, 0.1) !important;
      outline: none !important;
    }
    .ts-dropdown {
      background: #FFFFFF !important; 
      border: 1px solid #E5E7EB !important;
      border-radius: 8px !important;
      box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }
    .ts-option {
      color: #1F2937 !important; 
      padding: 10px 12px !important;
    }
    .ts-option.active, .ts-option:hover {
      background: #E53E3E !important; 
      color: #FFFFFF !important;
    }
    .ts-control .item {
       color: #1F2937 !important;
    }
    .ts-control input::placeholder { 
      color: #6B7280 !important;
    }
    .ts-dropdown .ts-input {
      background: #F9FAFB !important; 
      color: #1F2937 !important;
      border: 1px solid #E5E7EB !important;
      border-radius: 4px;
      margin: 8px;
      width: calc(100% - 16px);
      padding: 8px 10px;
    }
    .ts-dropdown .ts-input:focus {
      border-color: #E53E3E !important;
      outline: none;
    }
  </style>
  
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      new TomSelect('#produtoId', {
        plugins: ['dropdown_input'], 
        create: false,
        sortField: {
          field: "text",
          direction: "asc"
        }
      });
    });
  </script>

</section>
</html>