<!doctype html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org"
      <!-- Usa o layout padrão e define o título da página como "Home • Sudarê Sushi" -->
      th:replace="~{_layout :: layout(${'Home • Sudarê Sushi'}, 'home', ~{::content})}">

<section th:fragment="content">

    <!-- Header da página: botão de novo pedido + filtro por status -->
    <div class="form-row" style="justify-content: space-between; align-items: center;">
        <a class="btn" th:href="@{/pedidos/novo}">Abrir Novo Pedido</a>

        <!-- Form de filtro por status, dispara automaticamente ao mudar o select -->
        <form th:action="@{/}" method="GET" style="display: flex; align-items: center; gap: 10px;">
            <label for="statusFiltro" style="font-weight: 600; margin-bottom: 0;">Filtrar por Status:</label>
            <select id="statusFiltro" name="statusFiltro" class="form-control" 
                    style="width: 220px; height: 48px;" 
                    onchange="this.form.submit()">
                
                <!-- Opções de filtro, marcando a selecionada com base em statusFiltroAtivo -->
                <option value="NENHUM" th:selected="${statusFiltroAtivo == 'NENHUM'}">-- Selecione um filtro --</option>
                <option value="TODOS" th:selected="${statusFiltroAtivo == 'TODOS'}">Fila (Ativos)</option>
                <option value="ABERTO" th:selected="${statusFiltroAtivo == 'ABERTO'}">Abertos</option>
                <option value="EM_PREPARO" th:selected="${statusFiltroAtivo == 'EM_PREPARO'}">Em Preparo</option>
                <option value="PRONTO" th:selected="${statusFiltroAtivo == 'PRONTO'}">Prontos</option>
                <option value="ENTREGUE"   th:selected="${statusFiltroAtivo == 'ENTREGUE'}">Entregue</option>
                <option value="FINALIZADO" th:selected="${statusFiltroAtivo == 'FINALIZADO'}">Finalizados</option>
                <option value="CANCELADO"  th:selected="${statusFiltroAtivo == 'CANCELADO'}">Cancelados</option>
                <option value="TUDO" th:selected="${statusFiltroAtivo == 'TUDO'}">Todos (Histórico)</option>
            </select>
        </form>
    </div>


    <h2 class="section-title mt-22">Últimos pedidos</h2>

    <!-- Tabela principal de pedidos da home -->
    <div class="table-wrap">
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Cliente</th>
                    <th>Itens</th>
                    <th>Valor</th>
                    <th>Status</th>
                    <th>Atualizado</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                <!-- Loop pelos pedidos trazidos para a home -->
                <th:block th:each="p : ${ultimosPedidos}">
                    
                    <!-- Linha principal do pedido: pode estar em modo normal ou edição de status -->
                    <tr th:classappend="${statusEditId != null AND p.id == statusEditId} ? 'row-disabled' : 'row-clickable'"
                        th:onclick="|toggleItens(this, '${p.id}')|">

                        <!-- Quando está em modo edição de status -->
                        <th:block th:if="${statusEditId != null AND p.id == statusEditId}">
                            <td style="vertical-align: middle;" th:text="${p.id}">#</td>
                            <td style="vertical-align: middle;">
                                <!-- Divide nome e observação, se tiver parênteses -->
                                <th:block th:if="${#strings.contains(p.nomeClienteObservacao, '(')}">
                                    <span th:text="${#strings.substringBefore(p.nomeClienteObservacao, '(')}" style="font-weight: 600;"></span>
                                    <br/>
                                    <small style="color: var(--muted);" th:text="${'(' + #strings.substringAfter(p.nomeClienteObservacao, '(')}"></small>
                                </th:block>
                                <th:block th:unless="${#strings.contains(p.nomeClienteObservacao, '(')}">
                                    <span th:text="${p.nomeClienteObservacao}" style="font-weight: 600;"></span>
                                </th:block>
                            </td>
                            <td style="vertical-align: middle;" th:text="${#lists.size(p.itens)}">0</td>
                            <td style="vertical-align: middle;"
                                th:text="${'R$ ' + #numbers.formatDecimal(p.total,1,'POINT',2,'COMMA')}">R$ 0,00</td>
                            <td colspan="3" style="vertical-align: middle;">
                                <!-- Form para escolher e salvar novo status -->
                                <form th:action="@{/pedidos/atualizar-status}" method="POST"
                                      style="display: flex; align-items: center; gap: 6px;">
                                    <input type="hidden" name="id" th:value="${p.id}" />
                                    <input type="hidden" name="statusFiltro" th:value="${statusFiltroAtivo}" />
                                    <select name="status" class="form-control" style="height: 34px; padding: 0 10px; min-width: 140px;">
                                        <option value="ABERTO"     th:selected="${p.status.name() == 'ABERTO'}">Aberto</option>
                                        <option value="EM_PREPARO" th:selected="${p.status.name() == 'EM_PREPARO'}">Em Preparo</option>
                                        <option value="PRONTO"     th:selected="${p.status.name() == 'PRONTO'}">Pronto</option>
                                        <option value="ENTREGUE"   th:selected="${p.status.name() == 'ENTREGUE'}">Entregue</option>
                                        <option value="FINALIZADO" th:selected="${p.status.name() == 'FINALIZADO'}">Finalizado</option>
                                        <option value="CANCELADO"  th:selected="${p.status.name() == 'CANCELADO'}">Cancelado</option>
                                    </select>
                                    <!-- Data/hora da criação -->
                                    <span style="color: var(--muted); margin-left: 10px; white-space: nowrap;"
                                          th:text="${#temporals.format(p.criadoEm, 'dd/MM HH:mm')}">
                                    </span>
                                    <button type="submit" class="btn btn-sm" style="margin-left: auto;">Salvar</button>
                                    <a th:href="@{/(statusFiltro=${statusFiltroAtivo})}" class="btn btn-sm btn-ghost">Cancelar</a>
                                </form>
                            </td>
                        </th:block>

                        <!-- Quando está em modo normal (sem editar status) -->
                        <th:block th:unless="${statusEditId != null AND p.id == statusEditId}">
                            <td th:text="${p.id}">#</td>
                            <td>
                                <!-- Exibe nome e observação em linhas separadas, se tiver parênteses -->
                                <th:block th:if="${#strings.contains(p.nomeClienteObservacao, '(')}">
                                    <span th:text="${#strings.substringBefore(p.nomeClienteObservacao, '(')}" style="font-weight: 600;"></span>
                                    <br/>
                                    <small style="color: var(--muted);" th:text="${'(' + #strings.substringAfter(p.nomeClienteObservacao, '(')}"></small>
                                </th:block>
                                <th:block th:unless="${#strings.contains(p.nomeClienteObservacao, '(')}">
                                    <span th:text="${p.nomeClienteObservacao}" style="font-weight: 600;"></span>
                                </th:block>
                            </td>
                            <td th:text="${#lists.size(p.itens)}">0</td>
                            <td th:text="${'R$ ' + #numbers.formatDecimal(p.total,1,'POINT',2,'COMMA')}">R$ 0,00</td>
                            <td>
                                <!-- Badge muda a cor conforme o status do pedido -->
                                <th:block th:switch="${p.status.name()}">
                                    <span th:case="'EM_PREPARO'" class="badge badge-warning" th:text="${p.status}"></span>
                                    <span th:case="'PRONTO'" class="badge badge-info" th:text="${p.status}"></span>
                                    <span th:case="'ENTREGUE'" class="badge badge-primary" th:text="${p.status}"></span>
                                    <span th:case="'FINALIZADO'" class="badge badge-success" th:text="${p.status}"></span>
                                    <span th:case="'CANCELADO'" class="badge badge-danger" th:text="${p.status}"></span>
                                    <span th:case="*" class="badge" th:text="${p.status}"></span> 
                                </th:block>
                            </td>
                            <td th:text="${#temporals.format(p.criadoEm, 'dd/MM HH:mm')}">agora</td>
                            <td style="white-space: nowrap;">
                                <!-- Ir para tela de edição dos itens do pedido -->
                                <a th:href="@{/pedidos/editar/{id}(id=${p.id})}" class="btn btn-sm">
                                    Editar Itens
                                </a>
                                <!-- Botão para entrar em modo de alteração de status (se ainda não finalizado/cancelado) -->
                                <a th:if="${p.status.name() != 'FINALIZADO' AND p.status.name() != 'CANCELADO'}"
                                   th:href="@{/(statusEditId=${p.id}, statusFiltro=${statusFiltroAtivo})}" class="btn btn-sm btn-ghost">
                                   Alterar Status
                                </a>
                                <!-- Permite reabrir pedidos já finalizados ou cancelados -->
                                <form th:if="${p.status.name() == 'FINALIZADO' OR p.status.name() == 'CANCELADO'}"
                                      th:action="@{/pedidos/atualizar-status}" method="POST" style="display: inline-block; margin-left: 6px;">
                                    <input type="hidden" name="id" th:value="${p.id}" />
                                    <input type="hidden" name="status" value="ABERTO" />
                                    <input type="hidden" name="statusFiltro" th:value="${statusFiltroAtivo}" />
                                    <button type="submit" class="btn btn-sm btn-ghost">Reabrir</button>
                                </form>
                            </td>
                        </th:block>
                    </tr>
                    
                    <!-- Linha de detalhes dos itens do pedido, que expande ao clicar na linha principal -->
                    <tr class="itens-details-row" th:id="|itens-row-${p.id}|">
                        <td colspan="7">
                            <div class="itens-details-content">
                                <div style="font-weight: 600; margin-bottom: 5px;">Itens do Pedido:</div>
                                <ul>
                                    <li th:each="item : ${p.itens}" 
                                        th:text="${item.quantidade + 'x ' + item.produto.nome}">
                                        1x Produto
                                    </li>
                                    <li th:if="${#lists.isEmpty(p.itens)}">Nenhum item neste pedido.</li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                </th:block>

                <!-- Mensagem quando não existem pedidos para o filtro atual -->
                <tr th:if="${#lists.isEmpty(ultimosPedidos)}">
                    <td colspan="7" style="text-align: center; color: var(--muted);">
                        Nenhum pedido encontrado para este filtro.
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <!-- Estilos específicos para interação da tabela da home -->
    <style>
      .badge-info { background-color: #007bff; }
      .badge-primary { background-color: #6f42c1; }
      
      .row-clickable {
          cursor: pointer;
      }
      .row-clickable:hover {
          background-color: var(--bg);
      }
      .row-clickable.active {
          background-color: var(--bg);
      }
      
      .row-disabled {
          opacity: 0.6;
          cursor: not-allowed;
      }
      
      .itens-details-row {
          border-bottom: none;
      }
      .itens-details-row td {
          padding: 0;
      }
      .itens-details-content {
          background-color: var(--bg);
          overflow: hidden; 
          
          max-height: 0;
          transition: max-height 0.3s ease-out, padding 0.3s ease-out;
      }
      
      .itens-details-row.active .itens-details-content {
          max-height: 500px; 
          padding: 20px 50px; 
          transition: max-height 0.4s ease-in, padding 0.4s ease-in;
      }
      
      .itens-details-row ul {
          margin: 0;
          padding-left: 20px;
      }
    </style>

    <!-- Script para abrir/fechar os detalhes dos itens ao clicar na linha -->
    <script>
        function toggleItens(clickedRow, pedidoId) {
            if (clickedRow.classList.contains('row-disabled')) {
                return;
            }
            
            var row = document.getElementById('itens-row-' + pedidoId);

            clickedRow.classList.toggle('active');
            
            row.classList.toggle('active');
        }
    </script>
</section>
</html>
